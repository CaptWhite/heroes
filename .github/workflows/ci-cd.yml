name: Despliegue en VPS con Docker Compose

on:
  push:
    # Ejecuta el workflow cada vez que se haga un push a la rama 'main'
    branches:
      - main
  workflow_dispatch: # Permite ejecuci贸n manual desde GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest # Ejecuta en un runner hospedado por GitHub

    steps:
      - name: 猬锔 Checkout del c贸digo
        uses: actions/checkout@v4
        
      # --- Configuraci贸n SSH para Conexi贸n al VPS ---
      - name:  Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # Clave privada SSH de tu usuario en el VPS.
          # Debe estar almacenada en Secrets de GitHub (ej: SSH_PRIVATE_KEY)
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- Despliegue Remoto en el VPS ---
      # Paso 4: Desplegar
# Job de Despliegue (Job 'deploy')
# ...

# En tu archivo ci-cd.yml
# ...

      # Paso 4: Desplegar
      - name:  Deploy to VPSs via SSH
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
        run: |
      
          # El comando remoto se env铆a como una 煤nica cadena.
          ssh -o StrictHostKeyChecking=no $USER@$HOST "
            # Navegaci贸n y comandos remotos (se ejecutan en el VPS)
            cd /home/$USER/workspaces/heroes &&
            
            docker compose pull &&
            docker compose down &&
            docker compose --file docker-compose-prod.yml up -d &&

            echo 'Despliegue de contenedores finalizado y levantado.'
          "