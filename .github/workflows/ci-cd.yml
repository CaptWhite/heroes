name: Despliegue en VPS con Docker Compose

on:
  push:
    # Ejecuta el workflow cada vez que se haga un push a la rama 'main'
    branches:
      - main
  workflow_dispatch: # Permite ejecuciÃ³n manual desde GitHub UI

jobs:
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # 1. Add SSH known hosts (Necesario para las Actions de conexiÃ³n)
      - name: ðŸ” Add SSH known hosts
        env:
          HOST: ${{ secrets.SSH_HOST }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan "$HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # 2. Set up SSH agent (Necesario para todas las conexiones)
      - name: ðŸ”‘ Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      # 3. Sincronizar el archivo de Compose (SCP Action dedicada)
      # Transfiere el docker-compose-prod.yml del runner a tu VPS
      - name: ðŸ“¤ Sync docker-compose.yml file to VPS
        uses: upciti/scp-action@v2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ./docker-compose-prod.yml
          # El destino es el directorio de la aplicaciÃ³n en el VPS
          target: /home/${{ secrets.SSH_USER }}/workspaces/heroes/docker-compose-prod.yml
      
      # 4. Ejecutar comandos de Docker (SSH Action dedicada)
      # Ejecuta el pull/down/up de forma segura, sin errores de Bash
      - name: ðŸš€ Deploy containers and restart service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # NavegaciÃ³n al directorio de la aplicaciÃ³n
            cd /home/${{ secrets.SSH_USER }}/workspaces/heroes
            
            # Comandos de Docker (usando 'docker compose' V2)
            docker compose pull
            docker compose down
            docker compose --file docker-compose-prod.yml up -d

            echo "âœ… Despliegue de contenedores finalizado en VPS."

