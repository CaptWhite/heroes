name: Despliegue en VPS con Docker Compose

on:
  push:
    # Ejecuta el workflow cada vez que se haga un push a la rama 'main'
    branches:
      - main
  workflow_dispatch: # Permite ejecuci贸n manual desde GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest # Ejecuta en un runner hospedado por GitHub

    steps:
      - name: 猬锔 Checkout del c贸digo
        uses: actions/checkout@v4
        
      # --- Configuraci贸n SSH para Conexi贸n al VPS ---
      - name:  Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # Clave privada SSH de tu usuario en el VPS.
          # Debe estar almacenada en Secrets de GitHub (ej: SSH_PRIVATE_KEY)
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- Despliegue Remoto en el VPS ---
      # Paso 4: Desplegar
      - name:  Deploy to VPSs via SSH
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST << 'EOF'
            # --- Comandos ejecutados en el VPS ---
            
            # Navegaci贸n al directorio de la aplicaci贸n
            cd /home/$USER/workspaces/heroes
            
            # 1. Descargar las nuevas im谩genes del registro (V2)
            docker compose pull
            
            # 2. Detener los contenedores anteriores
            docker compose down
            
            # 3. Levantar los nuevos contenedores en modo detached (-d)
            # USAMOS EL ARCHIVO docker-compose-prod.yml que sincronizamos antes.
            docker compose --file docker-compose-prod.yml up -d
            
            # Confirma que el despliegue termin贸
            echo "Despliegue de contenedores finalizado y levantado."
          EOF