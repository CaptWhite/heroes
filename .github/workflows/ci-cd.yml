name: Despliegue en VPS con Docker Compose

on:
  push:
    # Ejecuta el workflow cada vez que se haga un push a la rama 'main'
    branches:
      - main
  workflow_dispatch: # Permite ejecuci贸n manual desde GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest # Ejecuta en un runner hospedado por GitHub

    steps:
      - name: 猬锔 Checkout del c贸digo
        uses: actions/checkout@v4
        
      # --- Configuraci贸n SSH para Conexi贸n al VPS ---
      - name:  Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # Clave privada SSH de tu usuario en el VPS.
          # Debe estar almacenada en Secrets de GitHub (ej: SSH_PRIVATE_KEY)
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- Despliegue Remoto en el VPS ---
      # Paso 4: Desplegar
# Job de Despliegue (Job 'deploy')
# ...

      # Paso 4: Desplegar
      - name:  Deploy to VPSs via SSH
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          # La clave es que el 'EOF' debe estar solo en una l铆nea,
          # y todos los comandos remotos deben estar tabulados o indentados
          # de manera uniforme, pero el 'EOF' final NO debe tener indentaci贸n.
          ssh -o StrictHostKeyChecking=no $USER@$HOST << 'EOF'
            # Comandos ejecutados en el VPS
            cd /home/$USER/workspaces/heroes
            
            docker compose pull
            docker compose down
            docker compose --file docker-compose-prod.yml up -d

            echo "Despliegue de contenedores finalizado y levantado."
          EOF
            # Confirma que el despliegue termin贸
            echo "Despliegue de contenedores finalizado y levantado."
          EOF