name: CI/CD Pipeline - Consolidada

# Dispara en push a main o manualmente
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # Variables de entorno comunes para los paths
  BACKEND_DIR: backend
  FRONTEND_DIR: frontend

jobs:
  # 1. IntegraciÃ³n Continua (Tests, Lint, Build & Push de ImÃ¡genes)
  # Este es el primer job y NO tiene 'needs'.
  ci_build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
        python-version: ['3.10']

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # --- CONFIGURACIÃ“N E INSTALACIÃ“N DE PYTHON (Backend) ---
      
      - name: ðŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ðŸ“¦ Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('${{ env.BACKEND_DIR }}/requirements.txt') }}

      - name: âš™ï¸ Install Backend dependencies
        run: pip install -r ${{ env.BACKEND_DIR }}/requirements.txt
        
      - name: ðŸ§ª Run Backend Tests (Pytest)
        run: cd ${{ env.BACKEND_DIR }} && pytest

      # --- CONFIGURACIÃ“N E INSTALACIÃ“N DE NODE (Frontend) ---

      - name: ðŸŸ¢ Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: ðŸ“¦ Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.FRONTEND_DIR }}/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('${{ env.FRONTEND_DIR }}/package.json') }}

      - name: âš™ï¸ Install Frontend dependencies (npm ci)
        run: cd ${{ env.FRONTEND_DIR }} && npm ci

      - name: ðŸ” Run Frontend Linting
        run: cd ${{ env.FRONTEND_DIR }} && npm run lint

      # --- BUILD Y PUSH DE DOCKER ---
      
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_TOKEN }}

      - name: ðŸ› ï¸ Build and push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ env.BACKEND_DIR }}
          push: true
          tags: |
            ${{ secrets.REGISTRY_URL }}/captwhite/astro-backend:${{ github.sha }}
            ${{ secrets.REGISTRY_URL }}/captwhite/astro-backend:latest
          
      - name: ðŸ› ï¸ Build and push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ env.FRONTEND_DIR }}
          push: true
          tags: |
            ${{ secrets.REGISTRY_URL }}/captwhite/astro-frontend:${{ github.sha }}
            ${{ secrets.REGISTRY_URL }}/captwhite/astro-frontend:latest

  # 2. Despliegue (CD)
  
  deploy:
    needs: ci_build # Depende del job consolidado
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # 1. Add SSH known hosts (Necesario para las Actions de conexiÃ³n)
      - name: ðŸ” Add SSH known hosts
        env:
          HOST: ${{ secrets.SSH_HOST }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan "$HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # 2. Set up SSH agent (Necesario para todas las conexiones)
      - name: ðŸ”‘ Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      # 3. Sincronizar el archivo de Compose (SCP Action dedicada)
      - name: ðŸ“¤ Sync docker-compose.yml file to VPS
        uses: upciti/scp-action@v2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ./docker-compose-prod.yml
          # El destino es el directorio de la aplicaciÃ³n en el VPS
          target: /home/${{ secrets.SSH_USER }}/workspaces/heroes/docker-compose-prod.yml
      
      # 4. Ejecutar comandos de Docker (SSH Action dedicada)
      - name: ðŸš€ Deploy containers and restart service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # NavegaciÃ³n al directorio de la aplicaciÃ³n
            cd /home/${{ secrets.SSH_USER }}/workspaces/heroes
            
            # Comandos de Docker (usando 'docker compose' V2)
            docker compose pull
            docker compose down
            docker compose --file docker-compose-prod.yml up -d

            echo "âœ… Despliegue de contenedores finalizado en VPS."