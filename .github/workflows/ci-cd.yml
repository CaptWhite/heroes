name: Despliegue en VPS con Docker Compose

on:
  push:
    # Ejecuta el workflow cada vez que se haga un push a la rama 'main'
    branches:
      - main
  workflow_dispatch: # Permite ejecuci√≥n manual desde GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest # Ejecuta en un runner hospedado por GitHub

    steps:
      - name: ‚¨áÔ∏è Checkout del c√≥digo
        uses: actions/checkout@v4
        
      # --- Configuraci√≥n SSH para Conexi√≥n al VPS ---
      - name: üîë Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # Clave privada SSH de tu usuario en el VPS.
          # Debe estar almacenada en Secrets de GitHub (ej: SSH_PRIVATE_KEY)
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- Despliegue Remoto en el VPS ---
      - name: üñ•Ô∏è Desplegar en VPS
        # Usa el cliente 'ssh' directamente para ejecutar comandos remotos
        env:
          # Variables de entorno para la conexi√≥n SSH.
          # Deben estar almacenadas en Secrets de GitHub (ej: VPS_HOST, VPS_USER)
          HOST: ${{ secrets.VPS_HOST }}
          USER: ${{ secrets.VPS_USER }}
        run: |
          echo "Conectando al VPS..."
          
          # Directorio donde se clonar√°/actualizar√° el c√≥digo en el VPS.
          DEPLOY_PATH="/home/$USER/heroes-app"
          REPO_URL="https://github.com/${{ github.repository }}.git"
          
          # Comando SSH para ejecutar m√∫ltiples acciones en el servidor
          ssh -o StrictHostKeyChecking=no $USER@$HOST << 'EOF'
            # (Comandos ejecutados dentro del VPS)
            
            # Crear el directorio si no existe
            mkdir -p $DEPLOY_PATH
            cd $DEPLOY_PATH

            # 1. Actualizar el c√≥digo
            if [ -d .git ]; then
              echo "Pulling latest changes..."
              git pull origin main
            else
              echo "Cloning repository..."
              git clone $REPO_URL .
            fi

            # 2. Construir y Desplegar con Docker Compose
            # -d: modo detached (en segundo plano)
            # --build: reconstruye las im√°genes (necesario tras un cambio en el c√≥digo/Dockerfiles)
            # --force-recreate: fuerza la recreaci√≥n de los contenedores
            echo "Running docker-compose up --build..."
            docker-compose up -d --build --force-recreate

            # 3. Limpiar im√°genes antiguas (opcional, para liberar espacio)
            # docker image prune -f
            
            echo "Despliegue finalizado."
            
          EOF
          
      - name: ‚úÖ Verificar Estado del Despliegue (Opcional)
        run: echo "El workflow se ha completado. Verifica tu VPS en http://${{ secrets.VPS_HOST }}:8088"
